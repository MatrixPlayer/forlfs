/*
 * deepv_service.h
 *
 *  Created on: Apr 20, 2016
 *      Author: chenzhen
 */

#ifndef DEEPV_SERVICE_H_
#define DEEPV_SERVICE_H_

#include <unistd.h>
#include <iostream>
#include <grpc++/grpc++.h>
#include <opencv2/core/core.hpp>
#include <opencv2/highgui/highgui.hpp>

#include "model/witness.grpc.pb.h"
#include "basic_service.h"
#include "config.h"

#include "model/frame.h"
#include "model/payload.h"
#include "engine/simple_engine.h"
#include "engine/witness_engine.h"

using namespace std;
using grpc::Server;
using grpc::ServerBuilder;
using grpc::ServerContext;
using grpc::Status;

namespace dg {
class WitnessServiceImpl : public WitnessService::Service 
{
 public:

    WitnessServiceImpl(Config *config)
            : config_(config) 
    {
    }

 private:
    Config *config_;

    grpc::Status Recognize(::grpc::ServerContext* context,
                           const ::dg::apps::RecognizeRequest* request,
                           ::dg::apps::RecognizeResponse* response) {
        cout << "Get Recognize request: " << request->sessionid()
                << ", Image URI:" << request->image().uri() << endl;
        cout << "Start processing: " << request->sessionid() << "..." << endl;
        Frame *frame = new Frame(request->sessionid());
        DLOG(INFO) << "Read data from test.jpg" << endl;
        cv::Mat image = cv::imread("test.jpg");
        Payload *payload = new Payload(request->sessionid(), image);
        frame->set_payload(payload);
        FrameBatch *framebatch = new FrameBatch(request->sessionid()*10,1);
        framebatch->AddFrame(frame);
        engine_->Process(framebatch);

        cout << "Finish processing: " << request->sessionid() << "..." << endl;
        cout << "=======" << endl;
        return grpc::Status::OK;
    }

    grpc::Status BatchRecognize(
            ::grpc::ServerContext* context,
            const ::dg::apps::BatchRecognizeRequest* request,
            ::dg::apps::BatchRecognizeResponse* response) {
        return grpc::Status::OK;
    }
};
}
}
#endif /* DEEPV_SERVICE_H_ */
